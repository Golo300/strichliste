name: Daily Binary Scan

on:
  push:
    branches:
      - 'main'
  schedule:
    # TÃ¤glich um 01:00 Uhr UTC
    - cron: '0 1 * * *'

jobs:
  binary-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Scan with Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          severity: HIGH,CRITICAL
          ignore-unfixed: true
          input: ./
          format: template
          template: "@./trivy-html-report-template.tpl"
          output: "report-tim.html"

      - uses: actions/upload-artifact@v4
        with:
          name: cve-report
          path: ./report-tim.html

      - name: Setup SSH
        run: |
          # setup / start ssh auth socket which manages our ssh keys when connecting to other servers via ssh
          ssh-agent -a $SSH_AUTH_SOCK > /dev/null
          # load the private key
          mkdir ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-add ~/.ssh/id_ed25519
          echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
        env:
          SSH_AUTH_SOCK: /tmp/ssh_agent.sock

      - name: Push report to server
        run: scp report-tim.html group6@dhbw.hoenle.xyz:/var/www/group6/report-timl.html
